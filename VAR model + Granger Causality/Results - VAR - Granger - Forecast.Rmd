---
title: "VAR analysis"
author: "Katie Schilling - 501130072"
date: "07/02/2022"
output: html_document
---
Required tools to be loaded
```{r}
library(dlookr)
library(lubridate)
library(data.table)
library(dplyr)
library(moments)
library(ggpubr)
library(smooth)
library(greybox)
library(forecast)
library(funModeling)
require(tidyverse)
require(tidymodels)
require(data.table)
require(tidyposterior)
require(tsibble)  #tsibble for time series based on tidy principles
require(fable)  #for forecasting based on tidy principles
require(ggfortify)  #for plotting timeseries
require(tseries)
require(chron)
require(lubridate)
require(directlabels)
require(zoo)
require(lmtest)
require(TTR)  #for smoothing the time series
require(MTS)
require(vars)
require(fUnitRoots)
require(lattice)
require(grid)

```

Import bothe Clean datasets
```{r}
Covid_monthly <- read.csv("C:/Users/Katie Schilling/Downloads/covid_monthly_clean.csv")
Vital_Events <- read.csv("C:/Users/Katie Schilling/Downloads/vital_events_clean.csv")

```

Combine the vital events data with the Covid Monthly data
```{r}
Final_dataset <- merge(x=Vital_Events, y=Covid_monthly, all = TRUE)
```

Check the data and ensure data merged properly
```{r}
summary(Final_dataset)
```

Change the N/A in the Covid Positive Cases to 0 so that the data is not omitted from the predictions
```{r}
Final_dataset$Covid[is.na(Final_dataset$Covid)] = 0
```

See if there are anymore NA's in the dataset
```{r}
Final_dataset %>% filter_all(any_vars(is.na(.))) 
```
Remove rows with NA as they will skew the results
```{r}
Final_dataset <- na.omit(Final_dataset)
```

Check for NA's to confirm all have been removed
```{r}
Final_dataset %>% filter_all(any_vars(is.na(.))) 
```
```{r}
summary(Final_dataset)
```

```{r}
Final_dataset$Date <- as.Date(Final_dataset$Date,"%Y-%m-%d")

```


```{r}
glimpse(Final_dataset)
```


Normalize the Data
```{r}

Final_dataset_standardized <- Final_dataset %>% mutate_each_(list(~scale(.) %>% as.vector),
                                  vars = c("Births","Marriages","Deaths","Stillbirths","Covid"))

```


Convert data frame to a time series
```{r}
Final_dataset_TS <- ts(Final_dataset_standardized[2:6], frequency = 12, start = 1994, end = 2021)
```

```{r}
plot(Final_dataset_TS)
```

```{r}
xyplot.ts(Final_dataset_TS)
```

---------------------------------------------------------------------------------------------------------------------------------------------------

decompose data and display results
```{r}
decomp <- decompose(Final_dataset_TS)
plot(decomp$seasonal)
plot(decomp$trend)
plot(decomp$random)
```


```{r}
Covid <- forecast(Final_dataset_TS[,5])
plot(Covid, main = "Covid Forecast")

```
```{r}
Stillbirths <- forecast(Final_dataset_TS[,4])
plot(Stillbirths, main = "Stillbirths Forecast")

```
```{r}
Deaths <- forecast(Final_dataset_TS[,3])
plot(Deaths, main = "Deaths Forecast")

```
```{r}
Marriages <- forecast(Final_dataset_TS[,2])
plot(Marriages, main = "Marriages Forecast")

```
```{r}
Births <- forecast(Final_dataset_TS[,1])
plot(Births, main = "Births Forecast")

```


---------------------------------------------------------------------------------------------------------------------------------------------------VAR time series forecasting for multivarite

```{r}
apply(Final_dataset_TS, 2, adf.test)
```

```{r}
stnry = diff(Final_dataset_TS) 

# Retest
apply(stnry, 2, adf.test)
```


```{r}
plot.ts(stnry)
```

```{r}
autoplot(ts(stnry,
            start = c(1964,1),
            frequency = 12)) +
  ggtitle("Time Series Plot of the stationary `Final Dataset' Time-Series")
```

```{r}
VARselect(stnry, 
          type = "none", #type of deterministic regressors to include. We use none becasue the time series was made stationary using differencing above. 
          lag.max = 20) #highest lag order
```

```{r}
# Creating a VAR model with vars
final_ts_var <- vars::VAR(stnry,
                   lag.max = 5, #highest lag order for lag length selection according to the choosen ic
                   ic = "HQ", #information criterion
                   type = "none") #type of deterministic regressors to include
summary(final_ts_var)

```

```{r}
serial.test(final_ts_var)
```

VAR model causality test for each variable against all other variables
```{r}
causality(final_ts_var, 
          cause = c("Deaths"))

```

```{r}
causality(final_ts_var,
          cause = c("Births")) 

```

```{r}
causality(final_ts_var, 
          cause = c("Covid")) 

```

```{r}
causality(final_ts_var, 
          cause = c("Marriages"))  

```

```{r}
causality(final_ts_var,
          cause = c("Stillbirths")) #

```

```{r}
fcast = predict(final_ts_var, n.ahead = 12) # predicting the 12 months after the data ends
par(mar = c(2,2,2,2))
plot(fcast)

```




```{r}
Final_forecast <- forecast(Final_dataset_TS, h=12 ) #Forecasting 12 months ahead
autoplot(Final_forecast, facets = T)
plot(Final_forecast)

```


```{r}
accuracy(Final_forecast,d= NULL, D=NULL)

```



